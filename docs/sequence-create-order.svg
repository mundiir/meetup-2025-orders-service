<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="977px" preserveAspectRatio="none" style="width:1248px;height:977px;" version="1.1" viewBox="0 0 1248 977" width="1248px" zoomAndPan="magnify"><defs><filter height="300%" id="f1138xy2civh43" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="95.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="367.5" y="146.5625"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="665.5" y="292.0938"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="782.5" y="350.3594"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="895.5" y="408.625"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1026.5" y="633.5547"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1170.5" y="762.7578"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="60.2656" style="stroke: #000000; stroke-width: 2.0;" width="395" x="65.5" y="203.6953"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="60.2656" style="stroke: #000000; stroke-width: 2.0;" width="395" x="65.5" y="452.7578"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="207.6016" style="stroke: #000000; stroke-width: 2.0;" width="845.5" x="274.5" y="527.0234"/><rect fill="#FFFFFF" height="148.3359" style="stroke: none; stroke-width: 1.0;" width="845.5" x="274.5" y="586.2891"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="132.3359" style="stroke: #000000; stroke-width: 2.0;" width="825.5" x="284.5" y="595.2891"/><rect fill="#FFFFFF" height="56.9375" style="stroke: none; stroke-width: 1.0;" width="825.5" x="284.5" y="670.6875"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="30" x2="30" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="137.5" x2="137.5" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="372.5" x2="372.5" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="670" x2="670" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="787" x2="787" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="900" x2="900" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1031" x2="1031" y1="86.2969" y2="868.1563"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1175" x2="1175" y1="86.2969" y2="868.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="8" y="82.9951">Client</text><ellipse cx="30.5" cy="13" fill="#FEFECE" filter="url(#f1138xy2civh43)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M30.5,21 L30.5,48 M17.5,29 L43.5,29 M30.5,48 L17.5,63 M30.5,48 L43.5,63 " fill="none" filter="url(#f1138xy2civh43)" style="stroke: #A80036; stroke-width: 2.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="39" x="8" y="880.1514">Client</text><ellipse cx="30.5" cy="893.4531" fill="#FEFECE" filter="url(#f1138xy2civh43)" rx="8" ry="8" style="stroke: #A80036; stroke-width: 2.0;"/><path d="M30.5,901.4531 L30.5,928.4531 M17.5,909.4531 L43.5,909.4531 M30.5,928.4531 L17.5,943.4531 M30.5,928.4531 L43.5,943.4531 " fill="none" filter="url(#f1138xy2civh43)" style="stroke: #A80036; stroke-width: 2.0;"/><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="75.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="82.5" y="70.9951">OrderController</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="120" x="75.5" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="106" x="82.5" y="887.1514">OrderController</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="294.5" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="301.5" y="70.9951">CreateOrderHandler</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="152" x="294.5" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="138" x="301.5" y="887.1514">CreateOrderHandler</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="614" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="621" y="70.9951">PromoService</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="109" x="614" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="95" x="621" y="887.1514">PromoService</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="737" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="744" y="70.9951">FxConverter</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="97" x="737" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="744" y="887.1514">FxConverter</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="848" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="855" y="70.9951">RiskChecker</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="101" x="848" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="87" x="855" y="887.1514">RiskChecker</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="963" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="970" y="70.9951">PaymentGateway</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="133" x="963" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="119" x="970" y="887.1514">PaymentGateway</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1110" y="51"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1117" y="70.9951">OrderRepository</text><rect fill="#FEFECE" filter="url(#f1138xy2civh43)" height="30.2969" style="stroke: #A80036; stroke-width: 1.5;" width="127" x="1110" y="867.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="113" x="1117" y="887.1514">OrderRepository</text><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="95.3984" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="367.5" y="146.5625"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="665.5" y="292.0938"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="782.5" y="350.3594"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="895.5" y="408.625"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1026.5" y="633.5547"/><rect fill="#FFFFFF" filter="url(#f1138xy2civh43)" height="29.1328" style="stroke: #A80036; stroke-width: 1.0;" width="10" x="1170.5" y="762.7578"/><polygon fill="#A80036" points="125.5,113.4297,135.5,117.4297,125.5,121.4297,129.5,117.4297" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="30.5" x2="131.5" y1="117.4297" y2="117.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="37.5" y="112.3638">POST /orders</text><polygon fill="#A80036" points="355.5,142.5625,365.5,146.5625,355.5,150.5625,359.5,146.5625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="137.5" x2="361.5" y1="146.5625" y2="146.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="211" x="144.5" y="141.4966">__invoke(CreateOrderCommand)</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="377.5" x2="419.5" y1="175.6953" y2="175.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419.5" x2="419.5" y1="175.6953" y2="188.6953"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="378.5" x2="419.5" y1="188.6953" y2="188.6953"/><polygon fill="#A80036" points="388.5,184.6953,378.5,188.6953,388.5,192.6953,384.5,188.6953" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="109" x="384.5" y="170.6294">validate currency</text><path d="M65.5,203.6953 L129.5,203.6953 L129.5,210.6953 L119.5,220.6953 L65.5,220.6953 L65.5,203.6953 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="60.2656" style="stroke: #000000; stroke-width: 2.0;" width="395" x="65.5" y="203.6953"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="80.5" y="216.7622">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="144.5" y="215.9058">[Unsupported currency]</text><polygon fill="#A80036" points="148.5,237.9609,138.5,241.9609,148.5,245.9609,144.5,241.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="142.5" x2="371.5" y1="241.9609" y2="241.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="154.5" y="236.895">throw UnsupportedCurrency</text><polygon fill="#A80036" points="360.5,251.9609,370.5,255.9609,360.5,259.9609,364.5,255.9609" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="137.5" x2="366.5" y1="255.9609" y2="255.9609"/><polygon fill="#A80036" points="653.5,288.0938,663.5,292.0938,653.5,296.0938,657.5,292.0938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="659.5" y1="292.0938" y2="292.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="274" x="379.5" y="287.0278">getDiscountPercent(promoCode, currency)</text><polygon fill="#A80036" points="383.5,317.2266,373.5,321.2266,383.5,325.2266,379.5,321.2266" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377.5" x2="669.5" y1="321.2266" y2="321.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="49" x="389.5" y="316.1606">percent</text><polygon fill="#A80036" points="770.5,346.3594,780.5,350.3594,770.5,354.3594,774.5,350.3594" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="776.5" y1="350.3594" y2="350.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="289" x="379.5" y="345.2935">convert(discountedAmount, currency, "USD")</text><polygon fill="#A80036" points="383.5,375.4922,373.5,379.4922,383.5,383.4922,379.5,379.4922" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377.5" x2="786.5" y1="379.4922" y2="379.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="103" x="389.5" y="374.4263">chargedAmount</text><polygon fill="#A80036" points="883.5,404.625,893.5,408.625,883.5,412.625,887.5,408.625" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="889.5" y1="408.625" y2="408.625"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="260" x="379.5" y="403.5591">isAllowed(order, chargedAmount, "USD")</text><polygon fill="#A80036" points="383.5,433.7578,373.5,437.7578,383.5,441.7578,379.5,437.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377.5" x2="899.5" y1="437.7578" y2="437.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="54" x="389.5" y="432.6919">allowed?</text><path d="M65.5,452.7578 L129.5,452.7578 L129.5,459.7578 L119.5,469.7578 L65.5,469.7578 L65.5,452.7578 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="60.2656" style="stroke: #000000; stroke-width: 2.0;" width="395" x="65.5" y="452.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="80.5" y="465.8247">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="87" x="144.5" y="464.9683">[Not allowed]</text><polygon fill="#A80036" points="148.5,487.0234,138.5,491.0234,148.5,495.0234,144.5,491.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="142.5" x2="371.5" y1="491.0234" y2="491.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="130" x="154.5" y="485.9575">throw OrderRejected</text><polygon fill="#A80036" points="360.5,501.0234,370.5,505.0234,360.5,509.0234,364.5,505.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="137.5" x2="366.5" y1="505.0234" y2="505.0234"/><path d="M274.5,527.0234 L338.5,527.0234 L338.5,534.0234 L328.5,544.0234 L274.5,544.0234 L274.5,527.0234 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="207.6016" style="stroke: #000000; stroke-width: 2.0;" width="845.5" x="274.5" y="527.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="19" x="289.5" y="540.0903">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="144" x="353.5" y="539.2339">[chargedAmount == 0]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="414.5" y1="565.2891" y2="565.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414.5" x2="414.5" y1="565.2891" y2="578.2891"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373.5" x2="414.5" y1="578.2891" y2="578.2891"/><polygon fill="#A80036" points="383.5,574.2891,373.5,578.2891,383.5,582.2891,379.5,578.2891" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="151" x="379.5" y="560.2231">transactionId = "free_*"</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="274.5" x2="1120" y1="587.2891" y2="587.2891"/><path d="M284.5,595.2891 L361.5,595.2891 L361.5,602.2891 L351.5,612.2891 L284.5,612.2891 L284.5,595.2891 " fill="#EEEEEE" style="stroke: #000000; stroke-width: 1.0;"/><rect fill="none" height="132.3359" style="stroke: #000000; stroke-width: 2.0;" width="825.5" x="284.5" y="595.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="32" x="299.5" y="608.356">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="116" x="376.5" y="607.4995">[up to 3 attempts]</text><polygon fill="#A80036" points="1014.5,629.5547,1024.5,633.5547,1014.5,637.5547,1018.5,633.5547" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="1020.5" y1="633.5547" y2="633.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="204" x="379.5" y="628.4888">charge(chargedAmount, "USD")</text><polygon fill="#A80036" points="383.5,658.6875,373.5,662.6875,383.5,666.6875,379.5,662.6875" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377.5" x2="1030.5" y1="662.6875" y2="662.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="83" x="389.5" y="657.6216">transactionId</text><line style="stroke: #000000; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="284.5" x2="1110" y1="671.6875" y2="671.6875"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="189" x="289.5" y="681.8979">[TransientPaymentException]</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="414.5" y1="706.625" y2="706.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="414.5" x2="414.5" y1="706.625" y2="719.625"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="373.5" x2="414.5" y1="719.625" y2="719.625"/><polygon fill="#A80036" points="383.5,715.625,373.5,719.625,383.5,723.625,379.5,719.625" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="124" x="379.5" y="701.5591">exponential backoff</text><polygon fill="#A80036" points="1158.5,758.7578,1168.5,762.7578,1158.5,766.7578,1162.5,762.7578" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="372.5" x2="1164.5" y1="762.7578" y2="762.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="74" x="379.5" y="757.6919">save(order)</text><polygon fill="#A80036" points="383.5,787.8906,373.5,791.8906,383.5,795.8906,379.5,791.8906" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="377.5" x2="1174.5" y1="791.8906" y2="791.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="15" x="389.5" y="786.8247">ok</text><polygon fill="#A80036" points="148.5,817.0234,138.5,821.0234,148.5,825.0234,144.5,821.0234" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="142.5" x2="371.5" y1="821.0234" y2="821.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="154.5" y="815.9575">OrderCreated</text><polygon fill="#A80036" points="41.5,846.1563,31.5,850.1563,41.5,854.1563,37.5,850.1563" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="35.5" x2="136.5" y1="850.1563" y2="850.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="79" x="47.5" y="845.0903">201 Created</text><a href="https://mundiir.github.io/meetup-2025-orders-service/c4-component.svg" target="_top" title="https://mundiir.github.io/meetup-2025-orders-service/c4-component.svg" xlink:actuate="onRequest" xlink:href="https://mundiir.github.io/meetup-2025-orders-service/c4-component.svg" xlink:show="new" xlink:title="https://mundiir.github.io/meetup-2025-orders-service/c4-component.svg" xlink:type="simple"><text fill="#0000FF" font-family="sans-serif" font-size="10" lengthAdjust="spacingAndGlyphs" text-decoration="underline" textLength="114" x="567.5" y="963.7354">Back to C4 Component</text></a><!--MD5=[9c668875ef0c3d0ec28c9229afbeab53]
@startuml

actor Client
participant "OrderController" as Controller
participant "CreateOrderHandler" as Handler
participant PromoService as Promo
participant FxConverter as Fx
participant RiskChecker as Risk
participant PaymentGateway as Payment
participant OrderRepository as Repo

Client -> Controller: POST /orders
Controller -> Handler: __invoke(CreateOrderCommand)
activate Handler

Handler -> Handler: validate currency
alt Unsupported currency
  Handler - -> Controller: throw UnsupportedCurrency
  deactivate Handler
  return
end

Handler -> Promo: getDiscountPercent(promoCode, currency)
activate Promo
Promo - -> Handler: percent
deactivate Promo

Handler -> Fx: convert(discountedAmount, currency, "USD")
activate Fx
Fx - -> Handler: chargedAmount
deactivate Fx

Handler -> Risk: isAllowed(order, chargedAmount, "USD")
activate Risk
Risk - -> Handler: allowed?
deactivate Risk

alt Not allowed
  Handler - -> Controller: throw OrderRejected
  deactivate Handler
  return
end

alt chargedAmount == 0
  Handler -> Handler: transactionId = "free_*"
else
  loop up to 3 attempts
    Handler -> Payment: charge(chargedAmount, "USD")
    activate Payment
    Payment - -> Handler: transactionId
    deactivate Payment
  else TransientPaymentException
    Handler -> Handler: exponential backoff
  end
end

Handler -> Repo: save(order)
activate Repo
Repo - -> Handler: ok
deactivate Repo

Handler - -> Controller: OrderCreated
deactivate Handler
Controller - -> Client: 201 Created

footer [[https://mundiir.github.io/meetup-2025-orders-service/c4-component.svg Back to C4 Component]]

@enduml

PlantUML version 1.2020.02(Sun Mar 01 10:22:07 UTC 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 17.0.17+10
Operating System: Linux
Default Encoding: UTF-8
Language: en
Country: null
--></g></svg>