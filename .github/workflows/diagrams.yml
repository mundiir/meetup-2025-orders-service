name: Build and Deploy Service Diagrams

on:
  push:
    branches: [ main, master ]
  workflow_dispatch: {}

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-diagrams-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PlantUML and Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y plantuml graphviz default-jre-headless

      - name: Rewrite footer links to absolute GitHub Pages
        env:
          OWNER: ${{ github.repository_owner }}
          BRANCH: ${{ github.ref_name }}
        run: |
          sed -i "s#../../../meetup-2025-landscape/c4/c2-containers.svg#https://$OWNER.github.io/meetup-2025-landscape/c4-containers.svg#g" docs/c4/component.puml
          sed -i "s#../../../meetup-2025-landscape/c4/c4-code-orders.svg#https://$OWNER.github.io/meetup-2025-landscape/c4-code-orders.svg#g" docs/c4/component.puml
          # Rewrite relative src links to GitHub repo
          sed -i "s#\../\../src/#https://github.com/$OWNER/meetup-2025-orders-service/tree/$BRANCH/src/#g" docs/c4/component.puml

      - name: Render PlantUML to SVG
        run: plantuml -tsvg docs/c4/*.puml

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/c4

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
